<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destiny 2 Tradutor de Armas e Perks</title>
    <!-- Incluindo Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fonte personalizada para um visual mais limpo */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a animação do loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gradiente suave com as cores do Brasil para a área de texto da esquerda */
        #pt-area {
            background: linear-gradient(135deg, rgba(0, 156, 59, 0.1), rgba(255, 223, 0, 0.1));
        }
        /* Gradiente suave com as cores da Inglaterra para a área de texto da direita */
        #en-area {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(207, 20, 43, 0.1));
        }
        
        /* Define uma altura de linha fixa para facilitar o cálculo da posição do botão */
        textarea {
            line-height: 1.5rem; /* 24px */
        }

        /* Estilo para o botão de link */
        #lightgg-link {
            transition: opacity 0.2s ease-in-out, top 0.1s linear;
        }
        .link-icon:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center min-h-screen p-4">

    <div id="app" class="w-full max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">Destiny 2 Tradutor</h1>
            <p class="text-lg text-gray-400">Traduza nomes de armas e perks entre Português e Inglês</p>
        </header>

        <!-- Seção do Loader -->
        <div id="loader-container" class="text-center p-8">
            <div class="loader inline-block"></div>
            <p class="mt-4 text-gray-300">Carregando definições de itens da Bungie...</p>
        </div>

        <!-- Conteúdo Principal do Tradutor (inicialmente oculto) -->
        <main id="translator-container" class="hidden">
            <!-- Layout de 3 colunas: PT | Botão | EN -->
            <div class="grid grid-cols-[1fr_auto_1fr] gap-4 items-start">
                <!-- Coluna Português (Input) -->
                <textarea id="pt-area" class="w-full h-80 border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none" placeholder="Digite aqui..."></textarea>
                
                <!-- Coluna do Botão de Link -->
                <div id="link-button-container" class="h-80 relative flex items-center justify-center w-16">
                    <a id="lightgg-link" href="#" target="_blank" class="absolute hidden p-2 bg-gray-700 hover:bg-blue-600 rounded-full transition-all duration-200 link-icon" title="Ver no light.gg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                          <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                          <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                        </svg>
                    </a>
                </div>

                <!-- Coluna Inglês (Input/Output) -->
                <textarea id="en-area" class="w-full h-80 border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none" placeholder="Ou digite aqui..."></textarea>
            </div>
        </main>
    </div>

    <script>
    (async function () {
        const apiKey = "4b9c63922cef407083762d343b64e34f"; 
        const ptToEn = {};
        const enToPt = {};

        const loaderContainer = document.getElementById('loader-container');
        const translatorContainer = document.getElementById('translator-container');
        const ptEl = document.getElementById('pt-area');
        const enEl = document.getElementById('en-area');
        const lightGgLink = document.getElementById('lightgg-link');
        
        let isUpdating = false;

        async function loadManifest() {
            try {
                const res = await fetch("https://www.bungie.net/Platform/Destiny2/Manifest/", { headers: { "X-API-Key": apiKey } });
                const manifest = await res.json();
                const ptUrl = "https://www.bungie.net" + manifest.Response.jsonWorldComponentContentPaths["pt-br"].DestinyInventoryItemDefinition;
                const enUrl = "https://www.bungie.net" + manifest.Response.jsonWorldComponentContentPaths["en"].DestinyInventoryItemDefinition;
                const [ptData, enData] = await Promise.all([fetch(ptUrl).then(r => r.json()), fetch(enUrl).then(r => r.json())]);

                for (const hash in ptData) {
                    const namePt = ptData[hash]?.displayProperties?.name?.trim();
                    const nameEn = enData[hash]?.displayProperties?.name?.trim();
                    if (namePt && nameEn) {
                        const itemData = { namePt, nameEn, hash };
                        ptToEn[namePt.toLowerCase()] = itemData;
                        enToPt[nameEn.toLowerCase()] = itemData;
                    }
                }
                loaderContainer.classList.add('hidden');
                translatorContainer.classList.remove('hidden');
            } catch (e) {
                console.error("Erro ao carregar Manifest da Bungie:", e);
                loaderContainer.innerHTML = '<p class="text-red-500">Falha ao carregar os dados. Por favor, recarregue a página.</p>';
            }
        }

        function handleTranslation(direction) {
            if (isUpdating) return;
            isUpdating = true;

            const sourceEl = direction === 'pt-en' ? ptEl : enEl;
            const targetEl = direction === 'pt-en' ? enEl : ptEl;
            const dictionary = direction === 'pt-en' ? ptToEn : enToPt;
            const dictionaryKeys = Object.keys(dictionary);
            
            const sourceLines = sourceEl.value.split('\n');
            const translatedTextLines = sourceLines.map(line => {
                const searchTerm = line.trim().toLowerCase();
                if (!searchTerm) return "";
                let result = dictionary[searchTerm] || dictionary[dictionaryKeys.find(key => key.includes(searchTerm))];
                return result ? (direction === 'pt-en' ? result.nameEn : result.namePt) : line;
            });

            targetEl.value = translatedTextLines.join('\n');
            updateLinkButton(sourceEl);
            setTimeout(() => { isUpdating = false; }, 10);
        }

        function updateLinkButton(activeTextArea) {
            if (!activeTextArea) {
                lightGgLink.classList.add('hidden');
                return;
            }
            const direction = activeTextArea.id === 'pt-area' ? 'pt-en' : 'en-pt';
            const dictionary = direction === 'pt-en' ? ptToEn : enToPt;
            const dictionaryKeys = Object.keys(dictionary);
            
            const text = activeTextArea.value;
            const cursorPosition = activeTextArea.selectionStart;
            const lineNum = text.substring(0, cursorPosition).split('\n').length - 1;
            const currentLineText = text.split('\n')[lineNum];
            
            const searchTerm = currentLineText.trim().toLowerCase();
            let result = dictionary[searchTerm] || dictionary[dictionaryKeys.find(key => key.includes(searchTerm))];

            if (result) {
                lightGgLink.href = `https://www.light.gg/db/items/${result.hash}`;
                lightGgLink.title = `Ver ${result.nameEn} no light.gg`;
                
                const style = window.getComputedStyle(activeTextArea);
                const lineHeight = parseFloat(style.lineHeight);
                const paddingTop = parseFloat(style.paddingTop);
                
                const topPosition = (lineNum * lineHeight) + paddingTop + (lineHeight / 2) - (lightGgLink.offsetHeight / 2);
                
                lightGgLink.style.top = `${topPosition}px`;
                lightGgLink.classList.remove('hidden');
            } else {
                lightGgLink.classList.add('hidden');
            }
        }

        ptEl.addEventListener('input', () => handleTranslation('pt-en'));
        enEl.addEventListener('input', () => handleTranslation('en-pt'));
        
        ['keyup', 'click', 'focus'].forEach(evt => {
            ptEl.addEventListener(evt, () => updateLinkButton(ptEl));
            enEl.addEventListener(evt, () => updateLinkButton(enEl));
        });

        await loadManifest();
    })();
    </script>

</body>
</html>
